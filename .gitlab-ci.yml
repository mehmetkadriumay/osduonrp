variables:
  UV_VERSION: 0.5.5
  PYTHON_VERSION: 3.13
  BASE_LAYER: bookworm-slim
  PACKAGE: cibutler
  UV_PUBLISH_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi"  
  UV_PUBLISH_USERNAME: "gitlab-ci-token"  
  UV_PUBLISH_PASSWORD: "${CI_JOB_TOKEN}"  
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

stages:
  - review
  - build
  - test
  - linters
  - scan
  - publish
  - deploy

deploy-pages:
  stage: build
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags: ["osdu-small"]
  pages: true # specifies that this is a Pages job
  script:
    - uv run $PACKAGE --help
    - uv run $PACKAGE docs generate --name $PACKAGE --output docs/docs/commands_reference.md
    - apt update
    - apt install git -y
    - pip install --default-timeout=1000 mkdocs-material
    - pip install termynal
    - pip install mkdocs-git-revision-date-plugin
    - cd docs
    - mkdocs build --site-dir ../public
  needs: []
  artifacts:
    paths:
      - public

build-python-package:
  stage: build
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags: ["osdu-small"]
  script:
    - apt update
    - apt install git -y
    - uv run $PACKAGE --help
      # Set the version in pyproject.toml based on VERSION file, pipeline details and git tags
    - VERSION=$(uv run setversion.py)  
    - echo "Setting version to $VERSION"
    - uvx --from=toml-cli toml set --toml-path=pyproject.toml project.version $VERSION
    - uv build
    #- uv run --with $PACKAGE --no-project -- python -c "import $PACKAGE"
  needs: []

publish-python-package:
  stage: publish
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags: ["osdu-small"]
  script:
    - apt update
    - apt install git -y
    - uv run $PACKAGE --help
      # Set the version in pyproject.toml based on VERSION file, pipeline details and git tags
    - VERSION=$(uv run setversion.py)  
    - uvx --from=toml-cli toml set --toml-path=pyproject.toml project.version $VERSION
    - uv build
    - uv run --with $PACKAGE --no-project -- python -c "import $PACKAGE"
    - uv publish dist/*.whl
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

compile-and-unit-test:
  stage: test
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  tags: ["osdu-small"]
  script:
    - uv run pytest -v --junit-xml=unit_tests_report.xml tests/unit
  coverage: '/^(?i)(TOTAL).*\s+(\d+\%)$/'
  artifacts:
    when: always
    reports:
      junit: unit_tests_report.xml

    expire_in: 2 days
  needs: []

analyze-python-dependencies:
  image: $CI_REGISTRY/osdu/platform/deployment-and-operations/release-scripts/tasklemon:v2.3
  tags: ['osdu-small']
  needs: ['compile-and-unit-test']
  stage: scan

  artifacts:
    paths:
      - python-dependencies.json

  script:
    - analyze-python.js
    - format-dependencies.js

prepare-release-notes:
  stage: build
  image: alpine:latest
  rules:
  - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+$/'
  script:
    - apk add curl jq
    - 'curl -H "PRIVATE-TOKEN: $CI_API_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/changelog?version=$CI_COMMIT_TAG" | jq -r .notes > release_notes.md'
  artifacts:
    paths:
    - release_notes.md
  when: manual

publish-release-notes:
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: prepare-release-notes
      artifacts: true
  rules:
  - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+$/'
  script:
    - echo "Creating release"
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: release_notes.md
    tag_name: '$CI_COMMIT_TAG'
    ref: '$CI_COMMIT_SHA'
    assets:
      links:
        - name: 'Container Image $CI_COMMIT_TAG'
          url: "https://$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA"
  when: manual

test-deployment-of-package:
  stage: deploy
  needs:
    - job: publish-python-package
      optional: true
  image: docker:dind
  allow_failure: true
  script:
    - export PATH=$PATH:$HOME/.local/bin
    - apk add curl kubectl python3 helm pipx
    - curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64
    - install minikube-linux-amd64 /usr/local/bin/minikube && rm minikube-linux-amd64
    - pipx install cibutler --index-url https://community.opengroup.org/api/v4/projects/1558/packages/pypi/simple --pip-args="--extra-index-url=https://community.opengroup.org/api/v4/projects/148/packages/pypi/simple"
    #- curl -LsSf https://astral.sh/uv/install.sh | sh
    #- export UV_LINK_MODE=copyexport 
    - $PACKAGE --help
    - $PACKAGE check --skip-docker-daemon
    #- $PACKAGE config-minikube --max-cpu --max-memory

include:
  - project: "osdu/platform/ci-cd-pipelines"
    file: "scanners/gitlab-ultimate.yml"

sonarqube-scan-python:
  stage: scan
  needs: ["compile-and-unit-test"]
  dependencies:
  - compile-and-unit-test
  rules:
  - if: $SONAR_CLOUD_TOKEN
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - |
      SONAR_SCANNER_OPTS="
        -Dsonar.host.url=${SONAR_CLOUD_URL}
        -Dsonar.token=${SONAR_CLOUD_TOKEN}
        -Dsonar.projectKey=org.opengroup.osdu:$CI_PROJECT_NAME
        -Dsonar.organization=osdu
        -Dsonar.python.coverage.reportPaths=coverage.xml"

      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        SONAR_SCANNER_OPTS="$SONAR_SCANNER_OPTS
          -Dsonar.pullrequest.gitlab.api_url=https://community.opengroup.org/api/v4
          -Dsonar.pullrequest.gitlab.project_id=$CI_PROJECT_ID
          -Dsonar.pullrequest.key=$CI_MERGE_REQUEST_IID
          -Dsonar.pullrequest.branch=$CI_COMMIT_REF_NAME
          -Dsonar.pullrequest.base=$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      fi
    - sonar-scanner $SONAR_SCANNER_OPTS

  allow_failure: true
